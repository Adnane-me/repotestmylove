name: Push to Khadija Repo - Diagnostic

on:
  push:
    branches:
      - main  # branche locale √† surveiller

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout le repo sans persister les credentials
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      # 2Ô∏è‚É£ Configurer Git (nom et email)
      - name: Configure Git
        run: |
          git config --global user.email "Adnane.Mehdaoui@usmba.ac.ma"
          git config --global user.name "Adnane-me"

      # 3Ô∏è‚É£ V√©rifier que le secret TEST est pr√©sent
      - name: Check Secret
        run: |
          if [ -z "${{ secrets.TEST }}" ]; then
            echo "‚ùå Secret TEST is empty"
            exit 1
          else
            echo "‚úÖ Secret TEST is present"
          fi

      # 4Ô∏è‚É£ Ajouter le remote et pousser sur une branche de test
      - name: Push to Test Branch
        env:
          GH_TOKEN: ${{ secrets.TEST }}
        run: |
          # Supprime remote si existant
          git remote remove khadija || true

          # Ajouter le remote avec PAT
          git remote add khadija https://x-access-token:${GH_TOKEN}@github.com/khadijaelmaaroufi/testadnankhadija.git

          # Cr√©er une branche de test bas√©e sur main
          git checkout -b test-push-${GITHUB_RUN_NUMBER}

          # V√©rifie l'acc√®s au repo distant
          echo "üîπ Test d'acc√®s au repo de Khadija"
          git ls-remote khadija

          # Push sur la branche de test
          echo "üîπ Tentative de push sur branche de test"
          git push khadija HEAD:test-push-${GITHUB_RUN_NUMBER} --force
